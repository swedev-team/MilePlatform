<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="iK59VZgs4hxes9no5v17viByFMZDRfcUtU5nEVLT">

    <title>Mile-Admin</title>

    <link rel="stylesheet" href="./css/admin.css">
    <link rel="stylesheet" href="./css/adminStyle.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!--<link rel="icon" href="./images/favicon.png" sizes="64*64"/>-->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

</head>

<body id="admin">
<div class="wrapper admin_page">

    <header class="header" id="header">

        <div class="container-fluid">

            <div class="row">
                <div class="col-lg-2 col-md-2 col-sm-2 col-xs-2">
                    <h1 class="logo child_position">
                        <a href="/admin" title="Homepage link">
                            <img src="./images/Miles-logo03_small.png" alt="로고"/>
                        </a>
                    </h1> <!-- END logo-->
                </div> <!-- END col-lg-2-->

                <div class="col-lg-10 col-md-10 col-sm-10 col-xs-10">
                    <nav class="navbar navbar-default gnbbox child_position">

                        <form method="get" action="/logoutAdmin">
                            <ul class="nav navbar-nav">
                                <li>
                                    <a href="/logoutAdmin">
                                        Logout
                                    </a>
                                </li>
                            </ul>
                        </form>
                    </nav>
                </div> <!-- END col-lg-10 -->
            </div> <!-- END row -->
        </div> <!-- END container-->
    </header>
    <!-- END header-->

    <section class="main">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-2 col-md-2 padding_none main_left">
                    <ul class="nav nav-tabs admin_tab_btn">
                        <li class="active">
                            <a data-toggle="tab" href="#admin_bb_tab">거래 관리</a>
                        </li>

                        <li>
                            <a data-toggle="tab" href="#user_tab">회원 관리</a>
                        </li>

                        <li>
                            <a data-toggle="tab" href="#adv_tab">관리자 관리</a>
                        </li>

                        <li>
                            <a data-toggle="tab" href="#project_tab">프로젝트 관리</a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#mail_tab">구독자 관리</a>
                        </li>
                        <li>
                            <a href="/showAdminHistory" target="_blank">관리자 처리 내역 조회</a>
                        </li>

                        {{#warning}}
                        <li>
                            <h3>warning:</h3>
                            {{warning}}
                        </li>
                        {{/warning}}
                    </ul>
                </div> <!-- END col-lg-2 -->

                <div class="col-lg-10 col-md-10 padding_none bg_base main_right tab-pane fade in active">
                    <div class="container_85">
                        <div class="tab-content admin_contents">

                            <div class="tab-pane fade in active" id="admin_bb_tab">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="admin_box transaction_list">
                                            <h3>거래 내역</h3>

                                            <div class="selectBox">
                                                <span>회차별 조회</span>
                                                <select class="trans_select">
                                                    <option value="all">전체</option>
                                                    {{#mileManagement}}
                                                    <option value="{{idx}}">{{idx}}회차</option>
                                                    {{/mileManagement}}
                                                </select> <!-- END trans_select-->
                                            </div> <!-- END selectBox-->

                                            <div class="ad_tran">
                                                {{#depositCount}}
                                                <span class="total_tran">
                                                        전체 거래
                                                        <span class="total_tran_num ad_point">{{depositCount}}</span>개
                                                    </span>
                                                {{/depositCount}}
                                                <!--END total_user-->

                                                <ul class="bd_bottom ad_tran_list ad_tran_title">
                                                    <li>날짜</li>

                                                    <li>회차</li>

                                                    <li>입금자 E-mail</li>

                                                    <li>총 입금 Ether</li>

                                                    <li>지급 예정 Mile</li>

                                                    <li>송금 확인</li>

                                                    <li>고객 계좌</li>
                                                </ul>

                                                <div class="ad_tranBox">
                                                    {{#deposits}}
                                                    <ul class="bd_bottom ad_tran_list ad_tran_txt"
                                                        name="{{mileManagement.idx}}">
                                                        <li>{{date}}</li>
                                                        <li>{{mileManagement.idx}}</li>
                                                        <li>{{user.email}}</li>
                                                        <li>{{amount}}eth</li>
                                                        <li>{{exMile}}mile</li>
                                                        {{^isReturned}}
                                                        <li>
                                                            <button type="submit" class="admin_btn withdraw_btn"
                                                                    name="{{id}}">확인
                                                            </button>
                                                        </li>
                                                        {{/isReturned}}

                                                        {{#isReturned}}
                                                        <li>확인 완료</li>
                                                        {{/isReturned}}
                                                        <li>{{user.address}}</li>
                                                    </ul>
                                                    {{/deposits}}
                                                </div>
                                                <!-- END ad_tranBox-->

                                            </div>
                                            <!-- END ad_tran-->

                                        </div>
                                        <!-- END transaction_list -->
                                    </div> <!--- END col-lg-12-->
                                </div> <!-- END row-->
                            </div> <!-- END admin_bb_tab-->

                            <div class="tab-pane fade in" id="user_tab">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="ad_search_form admin_box">
                                            <input type="text" placeholder="전체 사용자 검색" id="searchKey"/>
                                            <button type="submit" id="searchUser">검색</button>
                                        </div> <!-- END ad_search_form-->

                                        <div class="ad_user admin_box">
                                            <h3>사용자 목록</h3>
                                            {{#usersNum}}
                                            <span class="total_user">
                                                    전체 사용자
                                                    <span class="total_user_num ad_point">{{usersNum}}</span>
                                                    명
                                                </span>
                                            {{/usersNum}}
                                            <!--END total_user-->

                                            <ul class="bd_bottom ad_user_list ad_user_title">
                                                <li>
                                                    <a href="#">
                                                        <span class="ad_txt">NO.</span>
                                                        <span class="glyphicon glyphicon-triangle-bottom"></span>
                                                    </a>
                                                </li>

                                                <li>이름</li>

                                                <li>이메일</li>

                                                <li>전화번호</li>

                                                <li>KYC제출</li>

                                                <li>KYC승인</li>

                                                <li>삭제</li>
                                            </ul>
                                            <!-- END ad_user_list -->

                                            {{#users}}
                                            {{#isWithdraw}}
                                            <ul class="bd_bottom ad_user_list ad_user_txt" id="{{email}}" name="{{id}}">
                                                <li>{{id}}</li>
                                                <li>{{name}}</li>
                                                <li>{{email}}</li>
                                                <li>{{phoneNumber}}</li>
                                                <li>
                                                    {{#isSubmitted}}
                                                    <a href="/checkKyc/{{id}}" target="_blank"> 확인</a>
                                                    {{/isSubmitted}}

                                                    {{^isSubmitted}}
                                                    미제출
                                                    {{/isSubmitted}}
                                                </li>
                                                <li>
                                                    {{kycStatus}}
                                                </li>
                                                <li>
                                                    <button type="submit" class="admin_btn action_modal deleteUser">삭제
                                                    </button>
                                                </li>
                                            </ul>
                                            {{/isWithdraw}}
                                            {{/users}}
                                            <!-- END ad_user_list -->

                                        </div>
                                        <!--END ad_user-->
                                    </div> <!-- END col-lg-12 -->
                                </div> <!-- END row-->
                            </div><!-- END user_tab -->

                            <div class="tab-pane fade in" id="adv_tab">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="admin_setting">
                                            <div class="admin_form admin_box">
                                                <h3>관리자 설정</h3>
                                                <input type="email" name="email" placeholder="이메일을 입력하세요"
                                                       id="addAdminInput"/>
                                                <button type="submit" class="admin_btn action_modal" id="addAdmin">추가
                                                </button>
                                            </div>
                                            <!-- END admin_form -->
                                            <div class="admin_list_box admin_box">
                                                <h3>관리자 목록</h3>
                                                <ul class="bd_bottom ad_list ad_list_title">
                                                    <li>UserNO.</li>
                                                    <li>관리자이메일</li>
                                                    <li>관리권한제거</li>
                                                </ul>
                                                <!-- END ad_list-->

                                                {{#adminList}}
                                                <ul class="bd_bottom ad_list ad_list_txt" id="{{id}}">
                                                    <li>{{id}}</li>
                                                    <li>{{email}}</li>
                                                    <li>
                                                        <button type="submit"
                                                                class="admin_btn action_modal removeAdmin">제거
                                                        </button>
                                                    </li>
                                                </ul>
                                                <!-- END ad_list-->
                                                {{/adminList}}
                                            </div>
                                            <!-- END admin_list -->
                                        </div>
                                        <!-- END admin_setting -->
                                    </div><!-- END col-lg-12 -->
                                </div> <!-- END row-->
                            </div><!-- END adv_tab -->

                            <div class="tab-pane fade in" id="project_tab">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="project_setting">
                                            {{#progress}}
                                            <div class="admin_box projectBox">
                                                <h3>현재진행상황</h3>
                                                <p class="projectNow_desc">
                                                    <strong>
                                                        <span class="projectNow_Number">{{idx}}</span>
                                                        <span>회차</span>
                                                    </strong>
                                                </p><!-- END projectNow_desc-->
                                                <div class="processNow">
                                                    <p>진행률</p>
                                                    <div class="progress">
                                                        <div class="progress-bar"
                                                             role="progressbar"
                                                             aria-valuenow="{{selled}}"
                                                             aria-valuemin="0"
                                                             aria-valuemax="{{target}}">
                                                            {{percent}}% ( {{selled}}mile / {{target}}mile )
                                                        </div> <!-- END progress-bar-->
                                                    </div><!-- END progress-->
                                                </div> <!-- END processNow-->
                                            </div><!-- END projectBox-->
                                            <input type="hidden" value="{{percent}}" id="percent">
                                            {{/progress}}
                                            {{^progress}}
                                            <div class="admin_box projectBox" id="noProgress">
                                                <h3>현재 진행중인 프로젝트가 없습니다.</h3>
                                            </div>
                                            {{/progress}}

                                            {{^progress}}
                                            <div class="admin_box projectBigBox readyProject">
                                                <div class="proDet nailBox">
                                                    {{#isSaveManagement}}
                                                    <h3 id="plzSave">프로젝트를 저장해주세요</h3>
                                                    {{/isSaveManagement}}

                                                    {{^isSaveManagement}}
                                                    <div class="startProjectBox">
                                                        <h3>프로젝트를 시작하시려면 시작버튼을 눌러주세요</h3>
                                                        <button type="submit" class="admin_btn startProject">시작</button>
                                                    </div>
                                                    {{/isSaveManagement}}
                                                </div> <!-- END proDetailBox-->
                                            </div>
                                            {{/progress}}

                                            <div class="admin_box projectBigBox">
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="proDetailBox">
                                                            <h3>프로젝트 추가</h3>
                                                            <form action="" method="post"
                                                                  class="admin_form proDetailForm saveProjectForm">
                                                                <div class="row">
                                                                    <div class="project_detail clearfix">
                                                                        <div class="proSetting dateBox">
                                                                            <p>기간</p>
                                                                            <div class="dateSetting">
                                                                                <input type="text" id="datepicker1"
                                                                                       name="strStartDate">
                                                                                <span>~</span>
                                                                                <input type="text" id="datepicker2"
                                                                                       name="strEndDate">
                                                                            </div>
                                                                        </div> <!-- END proSetting-->
                                                                        <div class="proSetting">
                                                                            <p>목표액</p>
                                                                            <div class="goalCoin clearfix">
                                                                                <input type="text" class="ad_txt_form"
                                                                                       placeholder="목표금액을 적어주세요."
                                                                                       name="target" value="0"/> <span
                                                                                    class="ad_txt_bb">Mile</span>
                                                                            </div> <!-- END goalCoin-->
                                                                        </div> <!-- END proSetting-->
                                                                        <div class="proSetting">
                                                                            <p>환율</p>
                                                                            <div class="admin_exchange_rate">
                                                                                <div class="ad_form rate_form">
                                                                                    <span class="account_name">1 eth 당</span>
                                                                                    <span class="account_form">
                                                                            <input type="text" name="ratio"
                                                                                   class="ad_txt_form"
                                                                                   placeholder="교환 비율 작성" value="0.0"/>
                                                                            <span class="ad_txt_bb">Mile</span>
                                                                        </span>
                                                                                </div>
                                                                                <!-- END eh_account-->
                                                                            </div>
                                                                            <!-- END exchange_rate -->
                                                                        </div> <!-- END proSetting-->
                                                                        <div class="proSetting">
                                                                            <p>입금계좌</p>
                                                                            <div class="admin_account_setting">
                                                                                <div class="admin_account_form">
                                                                                    <div class="ad_form eh_account">
                                                                                        <span class="account_name">관리자 ETH계좌</span>
                                                                                        <input type="text"
                                                                                               name="address"
                                                                                               class="ad_txt_form"
                                                                                               placeholder="ETH 계좌 작성"/>
                                                                                    </div>
                                                                                    <!-- END eh_account-->
                                                                                </div>
                                                                                <!-- END admin_account_form -->
                                                                            </div> <!-- END admin_account_setting -->
                                                                        </div> <!-- END proSetting-->
                                                                        <button type="submit"
                                                                                class="admin_btn action_modal"
                                                                                id="saveProject">저장
                                                                        </button>
                                                                    </div> <!-- END project_detail-->
                                                                </div> <!-- END row-->
                                                            </form> <!-- END admin_form-->
                                                        </div> <!-- END proDetailBox-->
                                                    </div> <!-- END projectBigBox-->
                                                </div> <!-- END row-->
                                            </div>

                                            <div class="admin_box projectBigBox" id="projectInfo">
                                                {{#mileManagement}}
                                                <div class="row managementList" id="management_{{idx}}">
                                                    <div class="col-lg-12">
                                                        <div class="proDetailBox">
                                                            <h3>프로젝트 {{idx}} 회차 정보</h3>
                                                            <form action="" method="post"
                                                                  class="admin_form proDetailForm">
                                                                <div class="row">
                                                                    <div class="project_detail clearfix aj">
                                                                        <div class="proSetting dateBox">
                                                                            <p>기간</p>
                                                                            <div class="dateSetting">
                                                                                <input type="text" value="{{startDate}}"
                                                                                       readonly="readonly">
                                                                                <span>~</span>
                                                                                <input type="text" value="{{endDate}}"
                                                                                       readonly="readonly">
                                                                            </div>
                                                                        </div> <!-- END proSetting-->
                                                                        <div class="proSetting">
                                                                            <p>목표액</p>
                                                                            <div class="goalCoin">
                                                                                <input type="text" class="ad_txt_form"
                                                                                       value="{{target}}"
                                                                                       readonly="readonly"/><span
                                                                                    class="ad_txt_bb">Mile</span>
                                                                            </div> <!-- END goalCoin-->
                                                                        </div> <!-- END proSetting-->
                                                                        <div class="proSetting">
                                                                            <p>환율</p>
                                                                            <div class="admin_exchange_rate">
                                                                                <div class="ad_form rate_form">
                                                                                    <span class="account_name">1 eth 당</span>
                                                                                    <span class="account_form">
                                                                            <input type="text"
                                                                                   class="ad_txt_form"
                                                                                   value="{{ratio}}"
                                                                                   readonly="readonly"/>
                                                                            <span class="ad_txt_bb">Mile</span>
                                                                        </span>
                                                                                </div>
                                                                                <!-- END eh_account-->
                                                                            </div>
                                                                            <!-- END exchange_rate -->
                                                                        </div> <!-- END proSetting-->
                                                                        <div class="proSetting">
                                                                            <p>입금계좌</p>
                                                                            <div class="admin_account_setting">
                                                                                <div class="admin_account_form">
                                                                                    <div class="ad_form eh_account">
                                                                                        <span class="account_name">관리자 ETH계좌</span>
                                                                                        <input type="text"
                                                                                               class="ad_txt_form"
                                                                                               placeholder="ETH 계좌 작성"
                                                                                               readonly="readonly"
                                                                                               value="{{address}}"/>
                                                                                    </div>
                                                                                    <!-- END eh_account-->
                                                                                </div>
                                                                                <!-- END admin_account_form -->
                                                                            </div> <!-- END admin_account_setting -->
                                                                        </div> <!-- END proSetting-->
                                                                        {{^isProgress}}
                                                                        {{^isFinished}}
                                                                        <button type="submit"
                                                                                class="admin_btn action_modal removeProject"
                                                                                id="{{idx}}">
                                                                            삭제
                                                                        </button>
                                                                        {{/isFinished}}
                                                                        {{/isProgress}}
                                                                        <div id="pro_status_{{idx}}">
                                                                            {{#isProgress}}
                                                                            <p>현재 진행중입니다</p>
                                                                            {{/isProgress}}
                                                                            {{#isFinished}}
                                                                            <p>마감된 프로젝트 입니다</p>
                                                                            {{/isFinished}}
                                                                        </div>
                                                                    </div> <!-- END project_detail-->
                                                                </div> <!-- END row-->
                                                            </form> <!-- END admin_form-->
                                                            {{#isFinished}}
                                                            <div class="admin_box projectBox">
                                                                <div class="processNow">
                                                                    <p>달성률</p>
                                                                    <div class="progress">
                                                                        <div class="progress-bar"
                                                                             role="progressbar"
                                                                             aria-valuenow="{{selled}}"
                                                                             aria-valuemin="0"
                                                                             aria-valuemax="{{target}}"
                                                                             id="finish-progress">
                                                                            {{percent}}% ( {{selled}}mile /
                                                                            {{target}}mile )
                                                                        </div> <!-- END progress-bar-->
                                                                    </div><!-- END progress-->
                                                                </div> <!-- END processNow-->
                                                            </div><!-- END projectBox-->
                                                            <input type="hidden" value="{{percent}}"
                                                                   id="finish_percent">
                                                            {{/isFinished}}

                                                        </div> <!-- END proDetailBox-->
                                                    </div> <!-- END projectBigBox-->
                                                </div>
                                                <br><br>
                                                {{/mileManagement}}
                                            </div> <!-- END row-->
                                        </div> <!-- END project_setting--->
                                    </div> <!-- END col-lg-12-->
                                </div> <!-- END row-->
                            </div> <!-- END project_tab-->

                            <div class="tab-pane fade in" id="mail_tab">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="mail_box">

                                            <div class="admin_list_box admin_box" id="subs_box">
                                                <h3>메일 목록</h3>
                                                <div class="allCheck form-group">
                                                    <label for="all_checked">전체체크</label>
                                                    <input type="checkbox" id="all_checked"/>
                                                </div> <!-- END allCheck-->

                                                <ul class="bd_bottom ad_list ad_list_title">
                                                    <li>UserNO.</li>
                                                    <li>이메일</li>
                                                    <li>checked</li>
                                                </ul>
                                                <!-- END ad_list-->

                                                {{#subscriberList}}
                                                <ul class="bd_bottom ad_list ad_list_txt subscriber">
                                                    <li>{{id}}</li>
                                                    <li>{{email}}</li>
                                                    <li>
                                                        <div class="check_box">
                                                            <input type="checkbox"/>
                                                        </div> <!-- check_box-->
                                                    </li>
                                                </ul>
                                                <!-- END ad_list-->
                                                {{/subscriberList}}
                                                <div class="mailBtnBox">
                                                    <button type="button" class="mailBtn">메일보내기</button>
                                                </div> <!-- END mailBtnBox-->
                                            </div>
                                            <!-- END admin_list -->

                                        </div> <!-- END mail_box-->
                                    </div> <!-- END col-sm-12 -->
                                </div> <!-- END row-->
                            </div> <!-- END mail_tab-->
                        </div> <!-- END tab-content-->
                    </div> <!-- END container_85-->
                </div> <!-- END col-lg-10-->
            </div> <!-- END row-->
        </div> <!-- END container-fluid-->
    </section> <!-- END main -->

    <footer class="footer">
        <div class="container-fluid">


        </div> <!-- END container-->
    </footer> <!-- END footer-->
</div>
<!-- END admin_page -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
    $(function () {
        //progressBar
        $("#datepicker1, #datepicker2").datepicker();
        var percent = $("#percent").val();
        $(".progress-bar").css("width", percent + "%");

        var fipercent = $("#finish_percent").val();
        $("#finish-progress").css("width", fipercent + "%");

        //거래관리 회차별 조회
        $(".trans_select").change(function () {
            var selected = $(".trans_select option:selected").val();

            var deposits = document.getElementsByClassName("ad_tran_txt");

            if (selected == 'all') {
                for (var i = 0; i < deposits.length; i++) {
                    deposits[i].style.display = "block";
                }
            } else {
                for (var i = 0; i < deposits.length; i++) {
                    if (deposits[i].getAttribute('name') != selected) {
                        deposits[i].style.display = "none";
                    } else {
                        deposits[i].style.display = "block";
                    }
                }
            }
        });

        //유저 이메일 검색
        var userList = document.getElementsByClassName("ad_user_txt");
        $("#searchUser").click(function () {
            var email = $("#searchKey").val();


            for (var i = 0; i < userList.length; i++) {
                if (userList[i].getAttribute('id') == email) {
                    userList[i].style.display = "block";
                } else {
                    userList[i].style.display = "none";
                }
            }
            $("#searchKey").val('');

            $(".ad_search_form").append(`<button type="submit" id="allUser">전체보기</button>`);
        });

        $(document).on('click', '#allUser', function () {
            for (var i = 0; i < userList.length; i++) {
                userList[i].style.display = "block";
            }
            $(this).remove();
        });

        //유저 ajax삭제
        $(".deleteUser").click(function () {
            if (confirm('정말 삭제하시겠습니까?')) {
                var user = $(this).parent().parent();
                $.ajax({
                    url: '/admin/deleteUser',
                    type: 'POST',
                    data: {userId: user.attr('name')}
                })
                    .done(function (result) {
                        if (result == 'success') {
                            user.remove();
                            alert('삭제가 완료되었습니다.');
                        } else if (result == 'abnormal') {
                            location.reload();
                        } else {
                            alert(result);
                        }
                    })
                    .fail(function (err) {
                        console.error(err);
                    });
            }
        });

        //ajax 관리자 추가
        $("#addAdmin").click(function () {
            var exAdmin = $("#addAdminInput").val();
            if (confirm('정말 관리자를 추가하시겠습니까? : ' + exAdmin)) {
                $.ajax({
                    url: '/admin/addAdmin',
                    type: 'POST',
                    data: {email: exAdmin}
                })
                    .done(function (result) {
                        if (result == 'success') {
                            alert('관리자 추가가 완료되었습니다.');
                            var userId;
                            for (var i = 0; i < userList.length; i++) {
                                if (userList[i].getAttribute('id') == exAdmin) {
                                    userId = userList[i].getAttribute('name');
                                    break;
                                }
                            }
                            $(".admin_list_box").append(`<ul class="bd_bottom ad_list ad_list_txt"  id="${userId}">
                                                            <li>${userId}</li>
                                                            <li>${exAdmin}</li>
                                                            <li>
                                                                <button type="submit" class="admin_btn action_modal removeAdmin">제거</button>
                                                            </li>
                                                      </ul>`);
                        } else if (result == 'abnormal') {
                            location.reload();
                        } else {
                            alert(result);
                        }
                        $("#addAdminInput").val('');
                    })
                    .fail(function (err) {
                        console.error(err);
                    });
            }
        });

        //ajax 관리자 삭제
        $(document).on('click', '.removeAdmin', function () {
            var admin = $(this).parent().parent();
            if (confirm('정말 관리자를 제거하시겠습니까?')) {
                var id = $(admin).attr('id');

                $.ajax({
                    url: '/admin/removeAdmin',
                    type: 'POST',
                    data: {id: id}
                })
                    .done(function (result) {
                        if (result == 'success') {
                            alert('정상적으로 관리자가 제거되었습니다');
                            admin.remove();
                        } else if (result == 'abnormal') {
                            location.reload();
                        } else {
                            alert(result);
                        }
                    })
                    .fail(function (err) {
                        console.error(err);
                    })
            }
        });

        //ajax 송금처리
        $(".withdraw_btn").click(function () {
            if (confirm('정말 송금처리 하시겠습니까?')) {
                var deposit_id = $(this).attr('name');
                var deposit = $(this).parent();
                var brother = $(this).parent().siblings("li:nth-child(5)");
                $.ajax({
                    url: '/admin/withdraw',
                    type: 'POST',
                    data: {id: deposit_id}
                })
                    .done(result => {
                        if (result == 'success') {
                            alert('정상적으로 송금처리가 완료되었습니다')
                            deposit.remove();
                            $(brother).after(`<li>확인 완료</li>`);
                        } else if (result == 'abnormal') {
                            location.reload();
                        } else {
                            alert(result);
                        }
                    })
                    .fail(err => {
                        console.error(err);
                    })
            }
        });

        //ajax 프로젝트 추가
        $(".saveProjectForm").submit(function () {
            if (confirm('정말 프로젝트를 저장하시겠습니까?')) {
                $.ajax({
                    url: '/admin/saveProject',
                    type: 'POST',
                    data: $(this).serialize()
                })
                    .done(result => {
                        if (result.message == 'success') {
                            alert('정상적으로 프로젝트가 저장되었습니다');
                            $("#projectInfo").append(
                                `<div class="row managementList" id="management_${result.management.idx}">
                                <div class="col-lg-12">
                                    <div class="proDetailBox">
                                        <h3>프로젝트 ${result.management.idx} 회차 정보</h3>
                                        <form action="" method="post" class="admin_form proDetailForm">
                                            <div class="row">
                                                <div class="project_detail clearfix aj">
                                                    <div class="proSetting dateBox">
                                                        <p>기간</p>
                                                        <div class="dateSetting">
                                                            <input type="text" value="${result.management.startDate}" readonly="readonly">
                                                            <span>~</span>
                                                            <input type="text" value="${result.management.endDate}" readonly="readonly">
                                                        </div>
                                                    </div>
                                                    <div class="proSetting">
                                                        <p>목표액</p>
                                                            <div class="goalCoin">
                                                                <input type="text" class="ad_txt_form" value="${result.management.target}" readonly="readonly"/><span class="ad_txt_bb">Mile</span>
                                                            </div>
                                                    </div>
                                                    <div class="proSetting">
                                                        <p>환율</p>
                                                        <div class="admin_exchange_rate">
                                                            <div class="ad_form rate_form">
                                                                <span class="account_name">1 eth 당</span>
                                                                <span class="account_form">
                                                                    <input type="text" class="ad_txt_form" value="${result.management.ratio}" readonly="readonly"/>
                                                                    <span class="ad_txt_bb">Mile</span>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="proSetting">
                                                        <p>입금계좌</p>
                                                        <div class="admin_account_setting">
                                                            <div class="admin_account_form">
                                                                <div class="ad_form eh_account">
                                                                    <span class="account_name">관리자 ETH계좌</span>
                                                                    <input type="text" class="ad_txt_form" placeholder="ETH 계좌 작성" readonly="readonly" value="${result.management.address}"/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button type="submit" class="admin_btn action_modal removeProject" id="${result.management.idx}">삭제</button>
                                                    <div id="pro_status_${result.management.idx}">

                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                                <br><br>`
                            )

                            $("#plzSave").remove();
                            $(".startProjectBox:not(:first-child)").remove();
                            $(".readyProject").remove();
                            $(".readyProject").append(`<div class="startProjectBox">
                                                                 <h3>프로젝트를 시작하시려면 시작버튼을 눌러주세요</h3>
                                                                <button type="submit" class="admin_btn startProject">시작</button>
                                                             </div>`);

                            $(".saveProjectForm input[name=strStartDate]").val('');
                            $(".saveProjectForm input[name=strEndDate]").val('');
                            $(".saveProjectForm input[name=target]").val('');
                            $(".saveProjectForm input[name=ratio]").val('');
                            $(".saveProjectForm input[name=address]").val('');


                        } else if (result.message == 'abnormal') {
                            location.reload();
                        }
                        else {
                            alert(result.message);
                        }
                    })
                    .fail(err => {
                        console.error(err);
                    });
            }
            return false;
        });

        //ajax 프로젝트 삭제 ==> 몇회차 정보인지 안떙겨지는 이슈
        $(document).on('click', '.removeProject', function () {
            var idx = $(this).attr('id');

            if (confirm('정말 프로젝트를 삭제하시겠습니까?')) {
                $.ajax({
                    url: '/admin/removeProject',
                    type: 'POST',
                    data: {idx: idx}
                })
                    .done(result => {
                        if (result == 'success') {
                            alert('정상적으로 프로젝트가 삭제되었습니다');
                            $("#management_" + idx).remove();
                        } else if (result == 'abnormal') {
                            location.reload();
                        } else {
                            alert(result);
                        }
                    })
                    .fail(err => {
                        console.error(err);
                    })
            }
            return false;
        });

        //프로젝트 시작
        $(document).on('click', '.startProject', function () {
            if (confirm('프로젝트를 시작하시겠습니까?')) {
                $.ajax({
                    url: '/admin/startProject',
                    type: 'POST',
                    data: $(this).serialize()
                })
                    .done(result => {
                        if (result.message == 'success') {
                            $("#noProgress").remove();
                            $(".readyProject").remove();
                            $(`#management_${result.management.idx}`).find("button").remove();
                            $(".project_setting").prepend(
                                `<div class="admin_box projectBox">
                                                <h3>현재진행상황</h3>
                                                <p class="projectNow_desc">
                                                    <strong>
                                                        <span class="projectNow_Number">${result.management.idx}</span>
                                                        <span>회차</span>
                                                    </strong>
                                                </p>
                                                <div class="processNow">
                                                    <p>진행률</p>
                                                    <div class="progress">
                                                        <div class="progress-bar"
                                                             role="progressbar"
                                                             aria-valuenow="0"
                                                             aria-valuemin="0"
                                                             aria-valuemax="100">
                                                            0 %
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`)
                            $(`#pro_status_${result.management.idx}`).append(`<p>현재 진행중입니다</p>`);
                            alert('프로젝트가 정상적으로 시작되었습니다');
                        } else if (result.message == "abnormal") {
                            location.reload();
                        } else {
                            alert(result.message);
                        }
                    })
                    .fail(err => {
                        console.error(err);
                    })
            }
        });

        $(".mailBtn").click(function () {
            var subscriberList = document.getElementsByClassName("subscriber");
            var emailList = [];
            var nonChecked = 0;
            for (var i = 0; i < subscriberList.length; i++) {
                var subscriberIndex = subscriberList[i];
                if ($(subscriberIndex).find("input").prop("checked")) {
                    emailList.push($(subscriberIndex).children("li:nth-child(2)").text());
                } else {
                    nonChecked += 1;
                }
            }
            if (nonChecked == subscriberList.length) {
                alert("최소 1명이상 체크해 주세요");
            } else {

                var template = "<a href=" + '"' + "mailto:";

                for (var i = 0; i < emailList.length; i++) {
                    template = template + emailList[i] + ",";
                }
                template = template.slice(0, -1);
                template = template + '"' + " style=" + '"' + "visibility:hidden;" + '"' + " id=" + '"' + "subs_mail" + '"' + ">mail</a>";
                console.log(template);

                $("#subs_box").append(template);

                $("#subs_mail").get(0).click();

                $("#subs_mail").remove();
            }
        });

        $("#all_checked").change(function () {
            if ($("#all_checked").prop("checked")) {
                $("input[type=checkbox]").prop("checked", true);
            } else {
                $("input[type=checkbox]").prop("checked", false);
            }
        })
    });


</script>
</body>
<!-- END admin -->

</html>





